---
layout: tutorial_hands_on

title: "Differential exon usage analysis"
tags:
    - bulk
    - rna-seq
zenodo_link: "https://zenodo.org/record/3588250"
questions:
    - What are the steps to identify differentially expressed exons?
    - How to count exon usage?
objectives:
    - Estimate the number of reads per exons
    - Run a differential exon analysis
time_estimation: 2h
key_points:
    - 
requirements:
    -
        type: "internal"
        topic_name: transcriptomics
        tutorials:
            - ref-based
follow_up_training:
    -
        type: "internal"
        topic_name: transcriptomics
        tutorials:
            - ref-based
contributors:
    - bebatut
    - erxleben
    - pavanvidem
---


# Inference of the differential exon usage

In RNA-Seq, we usually want to know the differentially expressed genes, as explained in several tutorials. Sometimes,the question is more "which exons are differentially expressed".

The authors of {% cite brooks2011conservation %} depleted the *Pasilla* (*PS*) gene in *Drosophila melanogaster* by RNA interference (RNAi) to identify exons regulated by the *Pasilla* gene (the *Drosophila* homologue of the mammalian splicing regulators Nova-1 and Nova-2 proteins) using RNA-Seq data. 

The process to identify differentially expressed exons is really similar to the one for differentially expressed genes: quality control, mapping to a reference genes, counting and differential expression analysis, as described in the ["Reference-based RNA-Seq"]({{ site.baseurl }}{% link topics/transcriptomics/tutorials/ref-based/tutorial.md %}) or ["RNA-Seq reads to counts"]({{ site.baseurl }}{% link topics/transcriptomics/tutorials/rna-seq-reads-to-counts/tutorial.md %}) tutorials.

To illustrate how to infer differential exon usage, 7 of the original datasets from {% cite brooks2011conservation %} were taken, preprocessed for quality and mapped to the reference genome of the mouse, as explained in the ["Reference-based RNA-Seq"]({{ site.baseurl }}{% link topics/transcriptomics/tutorials/ref-based/tutorial.md %}).

Now, we would like to know the differential exon usage between treated (PS depleted) and untreated samples using RNA-Seq exon counts, using [DEXSeq](https://www.bioconductor.org/packages/release/bioc/html/DEXSeq.html) {% cite anders2012detecting %}. DEXSeq detects high sensitivity genes, and in many cases exons, that are subject to differential exon usage. But first, as for the differential gene expression, we need to count the number of reads mapping to the exons.

# Count the number of reads per exon

This step is similar to the step of [counting the number of reads per annotated gene]({{ site.baseurl }}/topics/transcriptomics/tutorials/ref-based/tutorial.md#count-the-number-of-reads-per-annotated-gene) except that, instead of **HTSeq-count**, we use **DEXSeq-Count**.

We will use here only 2 samples to illustrate the process while saving computation time.

> ### {% icon hands_on %} Hands-on: Counting the number of reads per exon
>
> 1. Create a new history
>
>    {% include snippets/create_new_history.md %}
>
> 2. Import the Ensembl gene annotation for *Drosophila melanogaster* (`Drosophila_melanogaster.BDGP6.87.gtf`) from the Shared Data library if available or from [Zenodo]({{ page.zenodo_link }}/files/Drosophila_melanogaster.BDGP6.87.gtf) into your current Galaxy history
>
>    ```
>    {{ page.zenodo_link }}/files/Drosophila_melanogaster.BDGP6.87.gtf
>    ```
>
>    1. Rename the dataset if necessary
>    2. Verify that the datatype is `gtf` and not `gff`, and that the database is `dm6`
>
> 1. **DEXSeq-Count** {% icon tool %}: Use the **DEXSeq-Count** to prepare the *Drosophila* annotations to extract only exons with corresponding gene ids
>     - *"Mode of operation"*: `Prepare annotation`
>       - {% icon param-file %} *"GTF file"*: `Drosophila_melanogaster.BDGP6.87.gtf`
>
>    The output is again a GTF file that is ready to be used for counting
>
> 2. Import the BAM files pairs from [Zenodo]({{ page.zenodo_link }}) or a data library:
>
>    ```
>    {{ page.zenodo_link }}/files/GSM461177.bam
>    {{ page.zenodo_link }}/files/GSM461180.bam
>    ```
>
> 2. **DEXSeq-Count** {% icon tool %}: Count reads using **DEXSeq-Count** with
>     - *"Mode of operation"*: `Count reads`
>       - {% icon param-files %} *"Input bam file"*: both `BAM` files
>       - {% icon param-file %} *"DEXSeq compatible GTF file"*: the GTF file generated by **DEXSeq-Count** {% icon tool %}
>       - *"Is library paired end?"*: `Yes`
>       - *"Is library strand specific?*: `No`
>       - *"Skip all reads with alignment quality lower than the given minimum value"*:  `10`
>
{: .hands_on}

DEXSeq generates a count table similar to the one generated by featureCounts, but with counts for exons.

> ### {% icon question %} Question
>
> 1. Which exon has the most reads mapped to it for both samples?
> 2. Which gene does this exon belong to?
> 3. Is there a connection to the previous result obtained with featureCounts?
>
> > ### {% icon solution %} Solution
> >
> > FBgn0000556:005 is the exon with the most reads mapped to it for both samples. It is part of FBgn0000556, the feature with the most reads mapped on it (from featureCounts).
> >
> {: .solution}
>
{: .question}

# Differential exon usage

DEXSeq usage is similar to DESeq2. It uses similar statistics to find differentially used exons.

As for DESeq2, in the previous step, we counted only reads that mapped to exons on chromosome 4 and for only one sample. To be able to identify differential exon usage induced by PS depletion, all datasets (3 treated and 4 untreated) must be analyzed following the same procedure. To save time, we did that for you. The results are available on [Zenodo]({{ page.zenodo_link }}):

- The results of running DEXSeq-count in 'Prepare annotation' mode
- Seven count files generated in 'Count reads' mode

> ### {% icon hands_on %} Hands-on:
>
> 1. Create a new history
> 2. Import the seven count files from [Zenodo]({{ page.zenodo_link }}) or the Shared Data library (if available):
>
>    ```
>    {{ page.zenodo_link }}/files/GSM461176_untreat_single.exon.counts
>    {{ page.zenodo_link }}/files/GSM461177_untreat_paired.exon.counts
>    {{ page.zenodo_link }}/files/GSM461178_untreat_paired.exon.counts
>    {{ page.zenodo_link }}/files/GSM461179_treat_single.exon.counts
>    {{ page.zenodo_link }}/files/GSM461180_treat_paired.exon.counts
>    {{ page.zenodo_link }}/files/GSM461181_treat_paired.exon.counts
>    {{ page.zenodo_link }}/files/GSM461182_untreat_single.exon.counts
>    ```
>
> 3. **DEXSeq** {% icon tool %}: Run **DEXSeq** with
>    - {% icon param-file %} *"GTF file created from DEXSeq-Count tool"*: `Drosophila_melanogaster.BDGP6.87.dexseq.gtf`
>    - In *"Factor"*:
>       - In "1: Factor"
>           - *"Specify a factor name"*: `condition`
>           - In *"Factor level"*:
>               - In *"1: Factor level"*:
>                   - *"Specify a factor level"*: `treated`
>                   - {% icon param-files %} *"Counts file(s)"*: the 3 exon count files with `treated` in their name
>               - In *"2: Factor level"*:
>                   - *"Specify a factor level"*: `untreated`
>                   - {% icon param-files %} *"Counts file(s)"*: the 4 exon count files with `untreated` in their name
>       - Click on *"Insert Factor"* (not on "Insert Factor level")
>       - In "2: Factor"
>           - "Specify a factor name" to `sequencing`
>           - In *"Factor level"*:
>               - In *"1: Factor level"*:
>                   - *"Specify a factor level"*: `PE`
>                   - {% icon param-files %} *"Counts file(s)"*: the 4 exon count files with `paired` in their name
>               - In *"2: Factor level"*:
>                   - *"Specify a factor level"*: `SE`
>                   - {% icon param-files %} *"Counts file(s)"*: the 3 exon count files with `single` in their name
>
>    > ### {% icon comment %} Comment
>    >
>    > Unlike DESeq2, DEXSeq does not allow flexible primary factor names. Always use your primary factor name as "condition"
>    {: .comment}
{: .hands_on}

Similarly to DESeq2, DEXSeq generates a table with:

1.  Exon identifiers
2.  Gene identifiers
3.  Exon identifiers in the Gene
4.  Mean normalized counts, averaged over all samples from both conditions
5.  Logarithm (to basis 2) of the fold change

    The log2 fold changes are based on primary factor level 1 vs. factor level 2. The order of factor levels is then important. For example, for the factor 'Condition', DESeq2 computes fold changes of 'treated' samples against 'untreated', *i.e.* the values correspond to up- or downregulations of genes in treated samples.

6.  Standard error estimate for the log2 fold change estimate
7.  *p*-value for the statistical significance of this change
8.  *p*-value adjusted for multiple testing with the Benjamini-Hochberg procedure which controls false discovery rate ([FDR](https://en.wikipedia.org/wiki/False_discovery_rate))

This can be then processed as the outputs of DESeq2: extraction and annotations of differentially expressed exons, visualisations of counts and Z-scores, functional enrichment analysis, etc. These steps are explained in the ["Reference-based RNA-Seq"]({{ site.baseurl }}{% link topics/transcriptomics/tutorials/ref-based/tutorial.md %}).

> ### {% icon hands_on %} Hands-on: Extract differentially expressed exons
>
> 1. **Filter** {% icon tool %} to extract exons with a significant differential usage (adjusted *p*-value equal or below 0.05) between treated and untreated samples
>
>    > ### {% icon question %} Question
>    >
>    > How many exons show a significant change in usage between these conditions?
>    >
>    > > ### {% icon solution %} Solution
>    > >
>    > > We get 38 exons (12.38%) with a significant usage change between treated and untreated samples
>    > >
>    > {: .solution}
>    {: .question}
{: .hands_on}

# Conclusion
{:.no_toc}

